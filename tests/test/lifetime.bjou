# lifetime.bjou

interface Foo {
    proc foo(this, f : float) : _ ref
}

abstract type S {
    implements idestroy 
    implements Foo
}

type T extends S {
    buf : char* # allocated memory
	f : float

    proc create() : T {
        print "Creating T"
        return { T: .buf = new char[1024] }
    }

    implements Foo {
        proc foo(this, f : float) : T ref {
            print "T.Foo.foo() with f = %", f
			this.f = f
            return this 
        }
    }

    implements idestroy {
        proc destroy(this) {
            print "Destroying T with f = %", this.f
            delete this.buf
        }
    }
}

type U extends S {
	f : float

    implements idestroy {
        proc destroy(this) {
            print "Destroying U with f = %", this.f
        }
    }
    implements Foo {
        proc foo(this, f : float) : U ref {
            print "U.Foo.foo() with f = %", f
			this.f = f
            return this
        }
    }
}

(proc main() {
    t := T.create()
    u := { U: }
    print "Lifetime"
    s_t := refcast$S(t)
    s_u := refcast$S(u)
    s_t.foo(1.23)
    s_u.foo(4.56)
})()
