# __sys.bjou
# This file was generated by gen_sys.
# system calls

module __sys

import "os.bjou"

extern nolibc_syscall(i64, i32, ...) : i32

\static_if{ os::OS != os::MACOS
    const SYS_NR_MOD := 0x0 }
\static_if{ os::OS == os::MACOS
    const SYS_NR_MOD := 0x2000000 }

type fd_t        = int
type mode_t      = u16
type time_t      = i64
type suseconds_t = i32

type timeval {
    tv_sec  : time_t
    tv_usec : suseconds_t
}
type timezone {
    tz_minuteswest : i32
    tz_dsttime     : i32
}
type timespec {
    tv_sec  : time_t
    tv_nsec : i64
}
proc time(t_p : time_t*) : time_t {
    tv := { timeval: }
    s  := gettimeofday(&tv, NULL as timezone*)
    if not t_p.isnull()    { @t_p = tv.tv_sec }
    return tv.tv_sec
}
proc sleep(s : u32) {
    elapsed := 0u32
    tv_beg := { timeval: }
    tv_now := { timeval: }
    gettimeofday(&tv_beg, NULL as timezone*)
    while elapsed < s {
        gettimeofday(&tv_now, NULL as timezone*)
        elapsed = tv_now.tv_sec - tv_beg.tv_sec
    }
}
proc usleep(u : u64) {
    elapsed := 0u64
    tv_beg := { timeval: }
    tv_now := { timeval: }
    gettimeofday(&tv_beg, NULL as timezone*)
    while elapsed < u {
        gettimeofday(&tv_now, NULL as timezone*)
        elapsed = ((tv_now.tv_sec * 1000000) + tv_now.tv_usec) - ((tv_beg.tv_sec * 1000000) + tv_beg.tv_usec)
    }
}

const SYS_write := SYS_NR_MOD + 4
const SYS_read := SYS_NR_MOD + 3
const SYS_open := SYS_NR_MOD + 5
const SYS_close := SYS_NR_MOD + 6
const SYS_exit := SYS_NR_MOD + 1
const SYS_lseek := SYS_NR_MOD + 199
const SYS_access := SYS_NR_MOD + 33
const SYS_getpid := SYS_NR_MOD + 20
const SYS_gettimeofday := SYS_NR_MOD + 116
const S_IRWXU := 448
const S_IRUSR := 256
const S_IWUSR := 128
const S_IXUSR := 64
const S_IRWXG := 56
const S_IRGRP := 32
const S_IWGRP := 16
const S_IXGRP := 8
const S_IRWXO := 7
const S_IROTH := 4
const S_IWOTH := 2
const S_IXOTH := 1
const O_RDONLY := 0
const O_WRONLY := 1
const O_RDWR := 2
const O_APPEND := 8
const O_CREAT := 512
const O_TRUNC := 1024
const O_EXCL := 2048
const SEEK_SET := 0
const SEEK_CUR := 1
const SEEK_END := 2
const F_OK := 0
const SIGHUP := 1
const SIGINT := 2
const SIGQUIT := 3
const SIGILL := 4
const SIGTRAP := 5
const SIGABRT := 6
const SIGIOT := 6
const SIGFPE := 8
const SIGKILL := 9
const SIGBUS := 10
const SIGSEGV := 11
const SIGSYS := 12
const SIGPIPE := 13
const SIGALRM := 14
const SIGTERM := 15
const SIGURG := 16
const SIGSTOP := 17
const SIGTSTP := 18
const SIGCONT := 19
const SIGCHLD := 20
const SIGTTIN := 21
const SIGTTOU := 22
const SIGIO := 23
const SIGXCPU := 24
const SIGXFSZ := 25
const SIGVTALRM := 26
const SIGPROF := 27
const SIGWINCH := 28
const SIGUSR1 := 30
const SIGUSR2 := 31
const _SC_NPROCESSORS_ONLN := 58

proc write(fd : i32, buf : void*, nbyte : u64) : i64
    return nolibc_syscall(SYS_write, 3, fd, buf, nbyte)

proc read(fd : i32, buf : void*, nbyte : u64) : i64
    return nolibc_syscall(SYS_read, 3, fd, buf, nbyte)

proc open(path: char*, oflag : int) : i64
    return nolibc_syscall(SYS_open, 2, path, oflag)

proc open(path: char*, oflag : int, mode : mode_t) : i64
    return nolibc_syscall(SYS_open, 3, path, oflag, mode)

proc close(fd : int) : i64
    return nolibc_syscall(SYS_close, 1, fd)

proc exit(status : int) : i64
    return nolibc_syscall(SYS_exit, 1, status)

proc lseek(fd : int, offset : u64, whence : int) : u64
    return nolibc_syscall(SYS_lseek, 3, fd, offset, whence)

proc access(path : char*, mode : int) : i64
    return nolibc_syscall(SYS_access, 2, path, mode)

proc getpid() : i64
    return nolibc_syscall(SYS_getpid, 0)

proc gettimeofday(tv : timeval*, tz : timezone*) : i64
    return nolibc_syscall(SYS_gettimeofday, 2, tv, tz)


extern sysctlbyname(char*, void*, u64, void*, u64) : int
extern sysconf(int) : i64

